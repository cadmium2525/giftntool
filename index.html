<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">

    <title>Monster Farm Sim</title>
    <link rel="stylesheet" href="css/style.css?v=2">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>

    <header>
        <h1>MF Sim</h1>
    </header>

    <main>
        <!-- Feature 1: Gift & Tyrant -->
        <section id="tab-gift" class="active">
            <div class="iframe-container">
                <iframe src="https://monster-farm-simulator.onrender.com" title="MF Simulator"></iframe>
                <button class="floating-scroll-btn"
                    onclick="document.getElementById('tyrant-calc').scrollIntoView({behavior: 'smooth'})">
                    ⬇ タイラントへ
                </button>
            </div>

            <div id="tyrant-calc" class="feature-title">ギフトン＆タイラント</div>

            <!-- 1. Parents Input First -->
            <div class="input-group">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="margin-bottom:10px;">親・祖父母を指定</label>
                    <button onclick="resetInputs('gift')"
                        style="font-size:0.75rem; padding:4px 8px; background:#444; border:none; color:#eee; border-radius:4px; cursor:pointer;">リセット</button>
                </div>

                <div class="parent-grid-row">
                    <div class="parent-label">父親側</div>
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">父親</div>
                        <div class="monster-btn large placeholder" data-slot="gf_f" onclick="openMonsterModal('gf_f')">
                            選択</div>
                    </div>
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">祖父</div>
                        <div class="monster-btn large placeholder" data-slot="gf_ff"
                            onclick="openMonsterModal('gf_ff')">選択</div>
                    </div>
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">祖母</div>
                        <div class="monster-btn large placeholder" data-slot="gf_fm"
                            onclick="openMonsterModal('gf_fm')">選択</div>
                    </div>
                </div>

                <div class="parent-grid-row">
                    <div class="parent-label">母親側</div>
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">母親</div>
                        <div class="monster-btn large placeholder" data-slot="gf_m" onclick="openMonsterModal('gf_m')">
                            選択</div>
                    </div>
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">祖父</div>
                        <div class="monster-btn large placeholder" data-slot="gf_mf"
                            onclick="openMonsterModal('gf_mf')">選択</div>
                    </div>
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">祖母</div>
                        <div class="monster-btn large placeholder" data-slot="gf_mm"
                            onclick="openMonsterModal('gf_mm')">選択</div>
                    </div>
                </div>

            </div>

            <!-- 2. Items Second -->
            <div class="input-group">
                <label>共通秘伝・加算値</label>
                <div style="margin-top:10px;">
                    <label>共通秘伝III (<span id="v3-val">0</span>個)</label>
                    <input type="range" id="secret3" min="0" max="20" value="0"
                        oninput="document.getElementById('v3-val').innerText = this.value">
                </div>
                <div style="margin-top:10px;">
                    <label>共通秘伝II (<span id="v2-val">0</span>個)</label>
                    <input type="range" id="secret2" min="0" max="20" value="0"
                        oninput="document.getElementById('v2-val').innerText = this.value">
                </div>
                <div style="margin-top:10px;">
                    <label>ノーブル加算値 (<span id="noble-val">0</span>)</label>
                    <input type="range" id="noble" min="0" max="300" value="0"
                        oninput="document.getElementById('noble-val').innerText = this.value">
                </div>
            </div>

            <button class="action-btn" onclick="runGiftSearch()">相性計算 / 一覧表示</button>

            <div id="gift-results" class="result-grid">
                <!-- Results will be injected here -->
            </div>
        </section>

        <!-- Feature 2: Optimization -->
        <section id="tab-optimize">
            <div class="feature-title">最適化探索</div>

            <div class="input-group">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label>育成モンスター (子)</label>
                    <button onclick="resetInputs('opt')"
                        style="font-size:0.75rem; padding:4px 8px; background:#444; border:none; color:#eee; border-radius:4px; cursor:pointer;">リセット</button>
                </div>
                <div class="monster-selector-row">
                    <div class="monster-btn large placeholder" data-slot="opt_child"
                        onclick="openMonsterModal('opt_child')">選択</div>
                </div>
            </div>

            <div class="input-group">
                <label>除外モンスター</label>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <button class="action-btn"
                        style="background:#444; font-size:0.9rem; width:auto; padding:8px 15px; margin-top:0;"
                        onclick="openExclusionModal()">設定を開く</button>
                    <div id="exclusion-count-opt" style="font-size:0.8rem; color:#aaa;">0体 除外中</div>
                </div>
                <div id="exclusion-icons-opt" class="excluded-list"></div>
            </div>

            <div class="input-group">
                <label>目標相性シンボル</label>
                <select id="target-symbol"
                    style="width:100%; padding:10px; background:#333; color:white; border:1px solid #555;">
                    <option value="999">指定なし (最大値を探索)</option>
                    <option value="660">👑 (660~)</option>
                    <option value="614">☆ (614~)</option>
                    <option value="490">◎ (490~)</option>
                </select>
            </div>

            <button class="action-btn" onclick="runOptimization()">最適化スタート</button>

            <div id="opt-results"></div>
        </section>

        <!-- Feature 3: Completion Search (Renamed from Reverse Opt) -->
        <section id="tab-reverse-opt">
            <div class="feature-title">補完探索</div>
            <div class="input-group">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label>育成モンスター (子)</label>
                    <button onclick="resetInputs('rev')"
                        style="font-size:0.75rem; padding:4px 8px; background:#444; border:none; color:#eee; border-radius:4px; cursor:pointer;">リセット</button>
                </div>
                <div class="monster-selector-row">
                    <div class="monster-btn large placeholder" data-slot="rev_child"
                        onclick="openMonsterModal('rev_child')">選択</div>
                </div>
            </div>

            <div class="input-group">
                <label>除外モンスター</label>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <button class="action-btn"
                        style="background:#444; font-size:0.9rem; width:auto; padding:8px 15px; margin-top:0;"
                        onclick="openExclusionModal()">設定を開く</button>
                    <div id="exclusion-count-rev" style="font-size:0.8rem; color:#aaa;">0体 除外中</div>
                </div>
                <div id="exclusion-icons-rev" class="excluded-list"></div>
            </div>

            <div class="input-group">
                <label>目標相性シンボル</label>
                <select id="target-symbol-rev"
                    style="width:100%; padding:10px; background:#333; color:white; border:1px solid #555;">
                    <option value="999">指定なし (最大値を探索)</option>
                    <option value="660">👑 (660~)</option>
                    <option value="614">☆ (614~)</option>
                    <option value="490">◎ (490~)</option>
                </select>
            </div>

            <div class="input-group">
                <label style="margin-bottom:10px;">固定枠 (空欄は最適探索)</label>

                <div class="parent-grid-row">
                    <div class="parent-label">父親側</div>
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">父親</div>
                        <div class="monster-btn placeholder" data-slot="rev_f" onclick="openMonsterModal('rev_f')">選択
                        </div>
                    </div>
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">祖父</div>
                        <div class="monster-btn placeholder" data-slot="rev_ff" onclick="openMonsterModal('rev_ff')">選択
                        </div>
                    </div>
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">祖母</div>
                        <div class="monster-btn placeholder" data-slot="rev_fm" onclick="openMonsterModal('rev_fm')">選択
                        </div>
                    </div>
                </div>

                <div class="parent-grid-row">
                    <div class="parent-label">母親側</div>
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">母親</div>
                        <div class="monster-btn placeholder" data-slot="rev_m" onclick="openMonsterModal('rev_m')">選択
                        </div>
                    </div>
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">祖父</div>
                        <div class="monster-btn placeholder" data-slot="rev_mf" onclick="openMonsterModal('rev_mf')">選択
                        </div>
                    </div>
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">祖母</div>
                        <div class="monster-btn placeholder" data-slot="rev_mm" onclick="openMonsterModal('rev_mm')">選択
                        </div>
                    </div>
                </div>
            </div>

            <button class="action-btn" onclick="runReverseOpt()">補完探索</button>
            <div id="rev-opt-results"></div>
        </section>

        <!-- Feature 4: General Reverse -->
        <section id="tab-general">
            <div class="feature-title">汎用逆引き探索</div>
            <p style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">
                指定した4人の祖父母から、全モンスターとの最低相性が最大になる父母の組み合わせを探します。<br>
                <span style="color:#eeaaaa;">※祖父母は最大2枠まで空欄（未指定）にできます。空欄の箇所も探索対象となります（処理に数秒かかります）。</span>
            </p>

            <div class="input-group">
                <label>除外モンスター</label>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <button class="action-btn"
                        style="background:#444; font-size:0.9rem; width:auto; padding:8px 15px; margin-top:0;"
                        onclick="openExclusionModal()">設定を開く</button>
                    <div id="exclusion-count-gen" style="font-size:0.8rem; color:#aaa;">0体 除外中</div>
                </div>
                <div id="exclusion-icons-gen" class="excluded-list"></div>
            </div>

            <div class="input-group">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="margin-bottom:10px;">祖父母を指定</label>
                    <button onclick="resetInputs('gen')"
                        style="font-size:0.75rem; padding:4px 8px; background:#444; border:none; color:#eee; border-radius:4px; cursor:pointer;">リセット</button>
                </div>

                <div class="parent-grid-row">
                    <div class="parent-label">父親側</div>
                    <div></div> <!-- Spacer -->
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">祖父</div>
                        <div class="monster-btn placeholder" data-slot="gen_ff" onclick="openMonsterModal('gen_ff')">選択
                        </div>
                    </div>
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">祖母</div>
                        <div class="monster-btn placeholder" data-slot="gen_fm" onclick="openMonsterModal('gen_fm')">選択
                        </div>
                    </div>
                </div>

                <div class="parent-grid-row">
                    <div class="parent-label">母親側</div>
                    <div></div> <!-- Spacer -->
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">祖父</div>
                        <div class="monster-btn placeholder" data-slot="gen_mf" onclick="openMonsterModal('gen_mf')">選択
                        </div>
                    </div>
                    <div>
                        <div style="font-size:0.7rem; color:#888; text-align:center; margin-bottom:2px;">祖母</div>
                        <div class="monster-btn placeholder" data-slot="gen_mm" onclick="openMonsterModal('gen_mm')">選択
                        </div>
                    </div>
                </div>
            </div>

            <button class="action-btn" onclick="runGeneralSearch()">汎用探索</button>
            <div id="gen-loading" style="display:none; text-align:center; margin-top:20px;">
                <div class="loader"></div>
                <div style="margin-top:10px; color:#aaa; font-size:0.9rem;">探索中... (数秒かかります)</div>
            </div>
            <div id="gen-results" class="result-grid"></div>
        </section>

    </main>

    <nav class="bottom-nav">
        <a class="nav-item active" onclick="switchTab('tab-gift', this)">
            <span class="nav-icon">🎁</span>
            <span>Gift/Tyrant</span>
        </a>
        <a class="nav-item" onclick="switchTab('tab-optimize', this)">
            <span class="nav-icon">✨</span>
            <span>最適探索</span>
        </a>
        <a class="nav-item" onclick="switchTab('tab-reverse-opt', this)">
            <span class="nav-icon">🧩</span>
            <span>補完探索</span>
        </a>
        <a class="nav-item" onclick="switchTab('tab-general', this)">
            <span class="nav-icon">🔍</span>
            <span>汎用探索</span>
        </a>
    </nav>

    <!-- Modal -->
    <div id="monster-modal" class="modal">
        <div class="modal-content">
            <h3>モンスター選択</h3>
            <div id="modal-grid" class="modal-grid">
                <!-- Injected via JS -->
            </div>
            <button class="modal-close" onclick="closeModal()">閉じる</button>
        </div>
    </div>

    <!-- Exclusion Modal -->
    <div id="exclusion-modal" class="modal">
        <div class="modal-content">
            <h3>除外モンスター設定</h3>
            <p style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">タップして除外/解除</p>
            <div id="exclusion-grid" class="modal-grid">
                <!-- Injected via JS -->
            </div>
            <button class="modal-close" onclick="closeExclusionModal()">完了</button>
        </div>
    </div>

    <script src="js/data.js"></script>
    <script src="js/script.js"></script>
</body>

</html>